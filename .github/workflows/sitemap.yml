name: è‡ªåŠ¨ç”Ÿæˆç½‘ç«™åœ°å›¾

on:
  # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'index.html'
      - 'sitemap_config.json'
      - '.github/workflows/sitemap.yml'
  
  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 2 * * 0'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install beautifulsoup4
    
    - name: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        if [ ! -f "index.html" ]; then
          echo "âŒ index.html æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ ! -f "auto_sitemap.py" ] && [ ! -f "generate_sitemap.py" ]; then
          echo "âŒ sitemapç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ‰€éœ€æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
    
    - name: ç”Ÿæˆç½‘ç«™åœ°å›¾
      run: |
        echo "ğŸš€ å¼€å§‹ç”Ÿæˆç½‘ç«™åœ°å›¾..."
        
        if [ -f "auto_sitemap.py" ]; then
          echo "ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬ç”Ÿæˆå™¨"
          python auto_sitemap.py
        elif [ -f "generate_sitemap.py" ]; then
          echo "ä½¿ç”¨åŸºç¡€ç‰ˆæœ¬ç”Ÿæˆå™¨"
          python generate_sitemap.py
        fi
        
        echo "âœ… ç½‘ç«™åœ°å›¾ç”Ÿæˆå®Œæˆ"
    
    - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ -f "sitemap.xml" ]; then
          echo "âœ… sitemap.xml ç”ŸæˆæˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -c < sitemap.xml) å­—èŠ‚"
          echo "ğŸ“Š URLæ•°é‡: $(grep -c '<url>' sitemap.xml)"
        else
          echo "âŒ sitemap.xml ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        if [ -f "robots.txt" ]; then
          echo "âœ… robots.txt ç”ŸæˆæˆåŠŸ"
        fi
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  æ²¡æœ‰æ–‡ä»¶å˜æ›´"
        fi
    
    - name: æäº¤å˜æ›´
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
        git add sitemap.xml
        [ -f "robots.txt" ] && git add robots.txt
        [ -f "sitemap_pages.json" ] && git add sitemap_pages.json
        
        # æäº¤å˜æ›´
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç½‘ç«™åœ°å›¾ - $(date '+%Y-%m-%d %H:%M:%S')"
        
        echo "âœ… å˜æ›´å·²æäº¤"
    
    - name: æ¨é€å˜æ›´
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: ä¸Šä¼ sitemapä½œä¸ºæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: sitemap-files
        path: |
          sitemap.xml
          robots.txt
          sitemap_pages.json
        retention-days: 30
    
    - name: æ˜¾ç¤ºç”Ÿæˆç»“æœ
      run: |
        echo "ğŸ‰ ç½‘ç«™åœ°å›¾ç”Ÿæˆå·¥ä½œæµå®Œæˆï¼"
        echo ""
        echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:"
        [ -f "sitemap.xml" ] && echo "  âœ… sitemap.xml"
        [ -f "robots.txt" ] && echo "  âœ… robots.txt"
        [ -f "sitemap_pages.json" ] && echo "  âœ… sitemap_pages.json"
        echo ""
        echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. æ£€æŸ¥ç”Ÿæˆçš„sitemap.xmlæ–‡ä»¶"
        echo "2. ç¡®ä¿ç½‘ç«™å¯ä»¥è®¿é—® sitemap.xml"
        echo "3. åœ¨æœç´¢å¼•æ“æ§åˆ¶å°ä¸­æäº¤sitemap"
        echo ""
        if [ -f "sitemap.xml" ]; then
          echo "ğŸ”— sitemapå†…å®¹é¢„è§ˆ:"
          head -20 sitemap.xml
        fi 